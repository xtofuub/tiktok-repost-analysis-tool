<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Repost Insights</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='3' width='18' height='18' rx='5' fill='none' stroke='%23111' stroke-width='2'/><circle cx='12' cy='12' r='3' fill='%23111'/></svg>">

  <!-- Tailwind CDN (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Dark (default) - made deeper per request */
      --bg: #050505;
      --card: #070707;
      --text: #efefef;
      --muted: #8f8f8f;
      --accent: #ff2a6d;
      --glass-border: rgba(255,255,255,0.06); /* stronger by default */
      --shadow: 0 10px 40px rgba(0,0,0,0.75);
      --control-bg: #070707;
      --focus-outline: rgba(255,255,255,0.12);
    }

    /* Light theme overrides */
    [data-theme="light"]{
      --bg: #ffffff;
      --card: #ffffff;
      --text: #111111;
      --muted: #666666;
      --accent: #0d6efd;
      --glass-border: rgba(0,0,0,0.06);
      --shadow: 0 6px 20px rgba(0,0,0,0.06);
      --control-bg: #f6f6f7;
    }

    /* Respect user preference on first load */
    @media (prefers-color-scheme: light){
      :root:not([data-theme]){ --bg: #ffffff; --card:#ffffff; --text:#111; --muted:#666; --accent:#0d6efd; --glass-border: rgba(0,0,0,0.06); --control-bg:#f6f6f7 }
    }

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color:transparent;
      line-height:1.5;
    }

    /* cards */
    .glass{
      background:var(--card);
      border:1px solid var(--glass-border);
      box-shadow:var(--shadow);
      /* subtle inner ring for stronger separation on very dark backgrounds */
      box-shadow: var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.01);
      transition:transform .18s ease,box-shadow .18s ease,border-color .18s ease,background .18s ease;
    }
    .glass:hover{ transform:translateY(-4px) }

    .word-cloud{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}

    .word-tooltip{
      position:absolute;bottom:100%;left:50%;transform:translateX(-50%) scale(.92);
      margin-bottom:.5rem;padding:.35rem .8rem;border-radius:8px;font-weight:700;font-size:.95rem;
      background:rgba(0,0,0,0.7);color:var(--text);border:1px solid rgba(255,255,255,0.04);white-space:nowrap;opacity:0;pointer-events:none;transition:all .16s ease;z-index:900
    }
    .word-tooltip.active{opacity:1;transform:translateX(-50%) scale(1)}
    .word-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border-left:7px solid transparent;border-right:7px solid transparent;border-top:8px solid rgba(0,0,0,0.7)}

    .cover-img{width:120px;height:160px;object-fit:cover;border-radius:12px;border:1px solid var(--glass-border);flex:0 0 auto}

    /* Prevent flex children from overflowing and ensure proper wrapping on small screens */
    .flex-1{min-width:0}

    /* Repost card: make responsive and stack on narrow viewports to avoid overlap */
    #repostList article{display:flex;align-items:flex-start;gap:1rem}
    @media (max-width:640px){
      #repostList article{flex-direction:column;align-items:stretch}
      #repostList article .cover-img{width:100%;height:auto;aspect-ratio:3/2}
      #repostList article .flex-1{width:100%}
      #repostList article .text-right{margin-top:.6rem;text-align:left}
      /* make internal stats grid adapt without overflowing */
      #repostList article .grid.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr));gap:.45rem}
    }

    .muted{color:var(--muted);font-size:.9rem}

    ::-webkit-scrollbar{height:9px;width:9px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.35);border-radius:8px}

    .item-hover{transition:all .18s ease}
    .item-hover:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,0.45)}

    .caption{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}

    .badge{background:transparent;color:var(--muted);padding:6px 10px;border-radius:8px;border:1px solid var(--glass-border);font-weight:600;font-size:.8rem}

    /* Controls */
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{background:var(--control-bg);border:1px solid var(--glass-border);color:var(--text);padding:.6rem .9rem;border-radius:10px;transition:box-shadow .15s ease,border-color .15s ease}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(13,110,253,0.06);border-color:var(--accent)}

    button{background:transparent;border:1px solid var(--glass-border);color:var(--text);padding:.6rem .9rem;border-radius:10px;cursor:pointer;min-height:44px;min-width:44px}
    button:hover{transform:translateY(-2px);filter:brightness(.98)}
    button:active{transform:translateY(0)}
    button[disabled]{opacity:.5;cursor:not-allowed}

    /* Prominent primary fetch button for visibility in dark theme */
    #fetchBtn{
      background:var(--accent);
      color: #ffffff;
      border: 0.5px solid rgba(0,0,0,0.15);
      box-shadow: 0 8px 24px rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.25) inset;
      font-weight:700;
      transition:transform .12s ease,filter .12s ease,box-shadow .12s ease;
    }
    #fetchBtn:hover{ filter:brightness(.98); transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,0.55) }
    #fetchBtn:active{ transform:translateY(0) ; box-shadow:0 6px 18px rgba(0,0,0,0.5) }
    #fetchBtn:focus-visible{ outline:3px solid rgba(255,255,255,0.08); outline-offset:3px }

    /* Slightly different accent in light theme for contrast */
    [data-theme="light"] #fetchBtn{ background:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(13,110,253,0.12) }

    .mode-switch{display:inline-flex;border-radius:9999px;overflow:hidden;border:1px solid var(--glass-border);background:var(--control-bg)}
    .mode-btn{padding:6px 10px;font-size:.78rem;font-weight:700;color:var(--muted);background:transparent;border:0}
    .mode-btn.active{color:var(--text);background:rgba(255,255,255,0.03)}

    /* Responsive helpers */
    @media (max-width:640px){
      .cover-img{width:96px;height:128px}
      .max-w-7xl{padding-left:12px;padding-right:12px}
    }

     /* Make the username + fetch controls more compact on small screens
       - stack input + button vertically
       - make button full width and slightly smaller padding
     */
    #singleControls{display:flex;gap:.5rem}
    @media (max-width:520px){
      #singleControls{flex-direction:column}
      #singleControls input,#singleControls #username{width:100%}
      #singleControls button,#fetchBtn{width:100%;padding:.55rem .7rem;font-size:.95rem}
    }

    @media (min-width:1024px){
      .cover-img{width:140px;height:190px}
    }

    /* Focus visible for keyboard users */
    :focus{outline:none}
    :focus-visible{outline:4px solid var(--focus-outline);outline-offset:3px}

    /* Make borders more visible across elements that use utility border classes
       This targets many Tailwind-style border-* class names pragmatically and
       ensures a consistent outline colour on the very dark theme. */
    [class*="border-"]{
      border-color:var(--glass-border) !important;
    }

    /* Ensure rounded containers and card areas also show the stronger border */
    .rounded-lg, .rounded-xl, header, footer, .glass, .badge, .p-3, .p-4, .p-5{
      border-color:var(--glass-border) !important;
    }

    /* Slightly stronger inner outline for cards for separation */
    .glass{box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,0.02)}
    
      /* Noticeable, dismissible disclaimer pill */
      .disclaimer{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .7rem;border-radius:10px;font-size:.9rem;background:rgba(255,42,109,0.08);border:1px solid rgba(255,42,109,0.15);color:var(--text)}
      .disclaimer .disclaimer-icon{font-size:1rem;opacity:.95}
      .disclaimer .disclaimer-text{color:var(--text)}
      .disclaimer .close-btn{margin-left:.5rem;background:transparent;border:0;color:var(--muted);cursor:pointer;padding:.2rem .4rem;border-radius:6px}
      .disclaimer .close-btn:focus{outline:2px solid rgba(255,255,255,0.06);outline-offset:2px}
      [data-theme="light"] .disclaimer{background:rgba(13,110,253,0.08);border-color:rgba(13,110,253,0.12)}

  </style>
</head>
<body class="min-h-screen flex flex-col">

  <div class="max-w-7xl mx-auto p-6 lg:p-8 flex-1 flex flex-col">
    <!-- Header -->
    <header class="mb-8 pb-6 border-b border-[#1a1a1a]">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold mb-2 text-white">TikTok Repost Insights</h1>
          <p class="muted">Analyze your repost patterns, trends, and discover your favorite creators</p>
        </div>
        <div class="text-right muted text-sm">
          <div class="flex items-center gap-2 justify-end">
            <div class="hidden sm:flex gap-2">
              <span class="badge">Chart.js</span>
            </div>
            <button id="themeToggle" class="glass" aria-pressed="false" title="Toggle theme" style="padding:8px;border-radius:10px;">
              <span id="themeIcon">üåô</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT SIDEBAR: Controls & Stats -->
      <section class="lg:col-span-1 space-y-4">
        <!-- Search Input -->
        <div id="controlsCard" class="glass p-5 rounded-xl">
          <label class="block text-sm font-medium mb-3 text-white">TikTok Username</label>
          <div id="singleControls" class="flex gap-2">
            <input 
              id="username" 
              class="flex-1 rounded-lg px-4 py-2.5 border focus:outline-none focus:ring-1 focus:ring-[#3a3a3a]" 
              placeholder="e.g. meowtuah" 
            />
            <button 
              id="fetchBtn" 
              aria-label="Fetch repost insights"
              class="rounded-lg px-6 py-2.5 font-semibold whitespace-nowrap"
            >
              Fetch
            </button>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <span class="muted text-xs">Mode</span>
            <div id="modeSwitch" class="mode-switch" role="group" aria-label="View mode">
              <button id="singleModeBtn" class="mode-btn active" aria-pressed="true">Single</button>
              <button id="duoModeBtn" class="mode-btn" aria-pressed="false">Duo</button>
            </div>
          </div>
          <div id="quota" class="mt-3 muted text-xs"></div>
          <div id="publicDisclaimer" class="disclaimer mt-2" role="status" aria-live="polite">
            <span class="disclaimer-icon" aria-hidden="true">‚ÑπÔ∏è</span>
            <span class="disclaimer-text">Note: This tool only works with public TikTok profiles.</span>
            <button id="dismissDisclaimer" class="close-btn" aria-label="Dismiss disclaimer">‚úï</button>
          </div>
        </div>

        <!-- Summary Stats -->
        <div id="summary" class="glass p-5 rounded-xl hidden">
          <div class="flex items-center justify-between mb-4 pb-4 border-b border-[#1a1a1a]">
            <div>
              <div class="text-xs muted mb-1">Username</div>
              <div id="s-username" class="text-xl font-bold text-white"></div>
            </div>
            <div class="text-right">
              <div class="text-xs muted mb-1">Total Reposts</div>
              <div id="s-count" class="text-3xl font-extrabold text-white">0</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="p-3 rounded-lg border border-[#1a1a1a] bg-[#050505]">
              <div class="muted text-xs mb-1">Capped</div>
              <div id="s-capped" class="font-semibold text-white">‚Äî</div>
            </div>
            <div class="p-3 rounded-lg border border-[#1a1a1a] bg-[#050505]">
              <div class="muted text-xs mb-1">Hard Cap</div>
              <div id="s-hardcap" class="font-semibold text-white">‚Äî</div>
            </div>
          </div>
          <div class="pt-3 border-t border-[#1a1a1a] grid grid-cols-2 gap-3">
            <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505]">
              <div class="muted text-xs mb-0.5">Pages</div>
              <div id="s-pages" class="font-semibold text-white text-sm">‚Äî</div>
            </div>
            <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505]">
              <div class="muted text-xs mb-0.5">Sampled</div>
              <div id="s-sampled" class="font-semibold text-white text-sm">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- Word Cloud -->
        <div id="wordCloudCard" class="glass p-5 rounded-xl hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">Word Cloud
              <span id="wcHint" class="muted text-xs ml-2">Tap or hover to view count</span>
            </h3>
            <div class="muted text-xs">Top tags</div>
          </div>
          <div id="wordCloud" class="word-cloud" aria-describedby="wcHint"></div>
        </div>

        <!-- Top Authors -->
        <div id="topAuthorsCard" class="glass p-5 rounded-xl hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">Top Authors</h3>
            <div class="muted text-xs">Most reposted</div>
          </div>
          <ul id="topAuthors" class="space-y-2 max-h-64 overflow-auto"></ul>
        </div>
      </section>

      <!-- MAIN CONTENT: Charts & Reposts -->
      <section class="lg:col-span-2 space-y-6">
        <!-- Analytics Charts -->
        <div id="analyticsCard" class="glass p-5 rounded-xl">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-semibold text-white">Analytics</h3>
            <div class="muted text-xs">Yearly & Monthly Trends</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <canvas id="yearChart" height="180"></canvas>
            </div>
            <div>
              <canvas id="monthChart" height="180"></canvas>
            </div>
          </div>
        </div>

        <div id="compareCard" class="glass p-5 rounded-xl hidden">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-semibold text-white">Compare Profiles</h3>
            <div class="muted text-xs">Word clouds & match</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
            <input id="compareA" class="rounded-lg px-4 py-2.5 border focus:outline-none focus:ring-1 focus:ring-[#3a3a3a]" placeholder="Username A" />
            <input id="compareB" class="rounded-lg px-4 py-2.5 border focus:outline-none focus:ring-1 focus:ring-[#3a3a3a]" placeholder="Username B" />
          </div>
          <div class="flex items-center gap-3 mb-4">
            <button id="compareBtn" class="rounded-lg px-6 py-2.5 font-semibold">Compare</button>
            <div id="compareStatus" class="muted text-xs"></div>
          </div>
          <div id="compareResult" class="hidden">
            <div class="flex items-center justify-between mb-4">
              <div class="muted text-xs">Match</div>
              <div id="compareMatch" class="text-2xl font-bold text-white">0%</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <div class="muted text-xs mb-1" id="compareLabelA"></div>
                <div id="compareWordCloudA" class="word-cloud"></div>
              </div>
              <div>
                <div class="muted text-xs mb-1" id="compareLabelB"></div>
                <div id="compareWordCloudB" class="word-cloud"></div>
              </div>
            </div>
            <div class="mt-4">
              <div class="muted text-xs mb-1">Overlap</div>
              <ul id="compareOverlap" class="space-y-1"></ul>
            </div>
          </div>
        </div>

        <!-- Reposts List -->
        <div id="repostsCard" class="glass p-5 rounded-xl">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-semibold text-white">Reposts</h3>
            <div class="muted text-xs">Click to open TikTok</div>
          </div>

          <!-- Loading Skeleton -->
          <div id="skeletonList" class="space-y-3">
            <template id="skeletonItem">
              <div class="flex gap-4 items-start animate-pulse">
                <div class="bg-[#1a1a1a] w-28 h-36 rounded-lg"></div>
                <div class="flex-1 space-y-2">
                  <div class="h-4 bg-[#1a1a1a] w-3/4 rounded"></div>
                  <div class="h-3 bg-[#1a1a1a] w-1/2 rounded"></div>
                  <div class="h-3 bg-[#1a1a1a] w-1/4 rounded"></div>
                </div>
              </div>
            </template>
          </div>

          <!-- Repost List -->
          <div id="repostList" class="space-y-3 max-h-[60vh] overflow-auto"></div>
        </div>

        <!-- Raw JSON -->
        <div class="glass p-5 rounded-xl hidden" id="rawCard">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-white">Raw JSON</h3>
            <div class="muted text-xs">API Response</div>
          </div>
          <pre id="raw" class="text-xs rounded-lg p-4 bg-[#050505] text-[#00ff00] border border-[#1a1a1a] overflow-auto max-h-64 font-mono"></pre>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="mt-auto pt-6 border-t border-[#1a1a1a] text-center muted text-xs">
      <div>Uses <span class="badge">corsproxy.io</span> by default. Replace `proxy` variable in JS with your own proxy for production.</div>
      <div class="mt-2">Note: The tool can only fetch data from public TikTok profiles.</div>
    </footer>
  </div>

  <!-- Post detail modal -->
  <div id="postModal" class="hidden fixed inset-0 z-50 flex items-center justify-center" aria-hidden="true">
    <div id="postModalOverlay" class="absolute inset-0" style="background:rgba(0,0,0,0.6)"></div>
    <div class="relative max-w-3xl w-full mx-4">
      <div class="glass p-4 rounded-xl" role="dialog" aria-modal="true" aria-labelledby="postModalTitle">
        <div class="flex flex-col md:flex-row items-start gap-4">
          <div style="flex:0 0 280px;max-width:40%;" class="w-full md:w-auto">
            <img id="modalCover" src="" alt="post cover" style="width:100%;height:auto;border-radius:10px;display:block;object-fit:cover" />
          </div>
          <div class="flex-1">
            <div class="flex items-start justify-between">
              <div>
                <h2 id="postModalTitle" class="text-lg font-semibold">Post details</h2>
                <div id="modalAuthor" class="muted text-sm mt-1"></div>
              </div>
              <div class="flex items-center gap-2">
                <button id="openExternalBtn" class="rounded px-3 py-1">Open on TikTok</button>
                <button id="copyLinkBtn" class="rounded px-3 py-1">Copy link</button>
                <button id="closeModalBtn" class="rounded px-2 py-1" aria-label="Close">‚úï</button>
              </div>
            </div>

            <div id="modalDesc" class="mt-3 caption muted"></div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
              <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505] text-center">
                <div class="muted text-xs">Plays</div>
                <div id="modalPlays" class="font-bold text-white">0</div>
              </div>
              <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505] text-center">
                <div class="muted text-xs">Likes</div>
                <div id="modalLikes" class="font-bold text-white">0</div>
              </div>
              <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505] text-center">
                <div class="muted text-xs">Comments</div>
                <div id="modalComments" class="font-bold text-white">0</div>
              </div>
              <div class="p-2 rounded-lg border border-[#1a1a1a] bg-[#050505] text-center">
                <div class="muted text-xs">Shares</div>
                <div id="modalShares" class="font-bold text-white">0</div>
              </div>
            </div>

            <div class="mt-4 text-xs muted">ID: <span id="modalId"></span></div>
            <div class="mt-1 text-xs muted">Date: <span id="modalDate"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Full client-side dashboard.
  NOTE: Uses a public CORS proxy (corsproxy.io) by default. Replace `proxy` with your own if you have one.
*/

const fetchBtn = document.getElementById('fetchBtn');
const usernameInput = document.getElementById('username');

const outputRawCard = document.getElementById('rawCard');
const rawPre = document.getElementById('raw');

const summaryCard = document.getElementById('summary');
const sUsername = document.getElementById('s-username');
const sCount = document.getElementById('s-count');
const sCapped = document.getElementById('s-capped');
const sHardcap = document.getElementById('s-hardcap');
const sPages = document.getElementById('s-pages');
const sSampled = document.getElementById('s-sampled');

const wordCloudCard = document.getElementById('wordCloudCard');
const wordCloudEl = document.getElementById('wordCloud');

const topAuthorsCard = document.getElementById('topAuthorsCard');
const topAuthorsEl = document.getElementById('topAuthors');

const repostList = document.getElementById('repostList');
const skeletonList = document.getElementById('skeletonList');
const skeletonTemplate = document.getElementById('skeletonItem');

const quotaEl = document.getElementById('quota');
const controlsCard = document.getElementById('controlsCard');
const singleControls = document.getElementById('singleControls');
const modeSwitch = document.getElementById('modeSwitch');
const singleModeBtn = document.getElementById('singleModeBtn');
const duoModeBtn = document.getElementById('duoModeBtn');
const analyticsCard = document.getElementById('analyticsCard');
const repostsCard = document.getElementById('repostsCard');
const compareCard = document.getElementById('compareCard');
const compareA = document.getElementById('compareA');
const compareB = document.getElementById('compareB');
const compareBtn = document.getElementById('compareBtn');
const compareStatus = document.getElementById('compareStatus');
const compareResult = document.getElementById('compareResult');
const compareMatch = document.getElementById('compareMatch');
const compareLabelA = document.getElementById('compareLabelA');
const compareLabelB = document.getElementById('compareLabelB');
const compareWordCloudA = document.getElementById('compareWordCloudA');
const compareWordCloudB = document.getElementById('compareWordCloudB');
const compareOverlap = document.getElementById('compareOverlap');

let yearChart = null;
let monthChart = null;
let duoMode = false;

function updateModeUI() {
  if (duoMode) {
    if (singleControls) singleControls.classList.add('hidden');
    if (summaryCard) summaryCard.classList.add('hidden');
    if (wordCloudCard) wordCloudCard.classList.add('hidden');
    if (topAuthorsCard) topAuthorsCard.classList.add('hidden');
    if (analyticsCard) analyticsCard.classList.add('hidden');
    if (repostsCard) repostsCard.classList.add('hidden');
    if (compareCard) compareCard.classList.remove('hidden');
    if (duoModeBtn) {
      duoModeBtn.classList.add('active');
      duoModeBtn.setAttribute('aria-pressed','true');
    }
    if (singleModeBtn) {
      singleModeBtn.classList.remove('active');
      singleModeBtn.setAttribute('aria-pressed','false');
    }
  } else {
    if (singleControls) singleControls.classList.remove('hidden');
    if (analyticsCard) analyticsCard.classList.remove('hidden');
    if (repostsCard) repostsCard.classList.remove('hidden');
    if (compareCard) compareCard.classList.add('hidden');
    if (duoModeBtn) {
      duoModeBtn.classList.remove('active');
      duoModeBtn.setAttribute('aria-pressed','false');
    }
    if (singleModeBtn) {
      singleModeBtn.classList.add('active');
      singleModeBtn.setAttribute('aria-pressed','true');
    }
  }
}

/* Default proxy ‚Äî you can change to your own server/proxy.
   Example: const proxy = "https://your-proxy.example.com/fetch?url=";
*/
const proxy = "https://corsproxy.io/?"; // quick dev proxy
//const proxy = ""; // if you host the HTML on same origin as your backend proxy, set accordingly

function showSkeleton(count = 4) {
  skeletonList.innerHTML = '';
  for (let i=0;i<count;i++){
    const node = skeletonTemplate.content.cloneNode(true);
    skeletonList.appendChild(node);
  }
  skeletonList.style.display = 'block';
  repostList.style.display = 'none';
}

function hideSkeleton() {
  skeletonList.style.display = 'none';
  repostList.style.display = 'block';
}

function clearUI() {
  summaryCard.classList.add('hidden');
  wordCloudCard.classList.add('hidden');
  topAuthorsCard.classList.add('hidden');
  outputRawCard.classList.add('hidden');
  repostList.innerHTML = '';
  wordCloudEl.innerHTML = '';
  topAuthorsEl.innerHTML = '';
  rawPre.textContent = '';
  quotaEl.textContent = '';
}

function buildWordCloud(words) {
  // words: [{text, value}, ...]
  wordCloudEl.innerHTML = '';
  if (!words || !words.length) {
    wordCloudEl.textContent = 'No words available';
    return;
  }
  // ensure there's a global helper to close any open tooltips (used for mobile taps)
  if (!window.__closeWordTooltips) {
    window.__closeWordTooltips = function() {
      document.querySelectorAll('.word-tooltip.active').forEach(t => t.classList.remove('active'));
    };
  }
  if (!window.__wordTooltipOutsideHandlerAdded) {
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.word-cloud')) window.__closeWordTooltips();
    }, { passive: true });
    document.addEventListener('touchstart', (e) => {
      if (!e.target.closest('.word-cloud')) window.__closeWordTooltips();
    }, { passive: true });
    window.__wordTooltipOutsideHandlerAdded = true;
  }
  // get min and max to scale font sizes between 12px and 36px
  const values = words.map(w => w.value);
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = Math.max(1, max - min);

  words.slice(0,60).forEach(w => {
    const norm = (w.value - min) / range;
    const size = Math.round(12 + norm * 24); // 12..36px
    const span = document.createElement('span');
    span.textContent = w.text;
    span.className = 'px-3 py-1.5 rounded-lg';
    span.style.position = 'relative';
    span.style.fontSize = size + 'px';
    span.style.color = '#ffffff';
    span.style.background = '#0a0a0a';
    span.style.border = '1px solid #1a1a1a';
    span.style.transition = 'all 0.2s ease';
    span.style.cursor = 'default';
    
    // Add tooltip element
    const tooltip = document.createElement('span');
    tooltip.className = 'word-tooltip';
    tooltip.textContent = w.value;
    span.appendChild(tooltip);
    
    // Hover for desktop
    span.onmouseenter = function() {
      this.style.background = '#111111';
      this.style.borderColor = '#2a2a2a';
      tooltip.classList.add('active');
    };
    span.onmouseleave = function() {
      this.style.background = '#0a0a0a';
      this.style.borderColor = '#1a1a1a';
      tooltip.classList.remove('active');
    };
    // Click / touch to toggle tooltip on mobile devices
    span.addEventListener('click', function(e){
      e.stopPropagation();
      // close other tooltips first
      window.__closeWordTooltips();
      // toggle this tooltip
      if (tooltip.classList.contains('active')) {
        tooltip.classList.remove('active');
      } else {
        tooltip.classList.add('active');
      }
    }, { passive: true });
    wordCloudEl.appendChild(span);
  });
}

function buildWordCloudInto(el, words) {
  el.innerHTML = '';
  if (!words || !words.length) {
    el.textContent = 'No words available';
    return;
  }
  if (!window.__closeWordTooltips) {
    window.__closeWordTooltips = function() {
      document.querySelectorAll('.word-tooltip.active').forEach(t => t.classList.remove('active'));
    };
  }
  if (!window.__wordTooltipOutsideHandlerAdded) {
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.word-cloud')) window.__closeWordTooltips();
    }, { passive: true });
    document.addEventListener('touchstart', (e) => {
      if (!e.target.closest('.word-cloud')) window.__closeWordTooltips();
    }, { passive: true });
    window.__wordTooltipOutsideHandlerAdded = true;
  }
  const values = words.map(w => w.value);
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = Math.max(1, max - min);
  words.slice(0,60).forEach(w => {
    const norm = (w.value - min) / range;
    const size = Math.round(12 + norm * 24);
    const span = document.createElement('span');
    span.textContent = w.text;
    span.className = 'px-3 py-1.5 rounded-lg';
    span.style.position = 'relative';
    span.style.fontSize = size + 'px';
    span.style.color = '#ffffff';
    span.style.background = '#0a0a0a';
    span.style.border = '1px solid #1a1a1a';
    span.style.transition = 'all 0.2s ease';
    span.style.cursor = 'default';
    const tooltip = document.createElement('span');
    tooltip.className = 'word-tooltip';
    tooltip.textContent = w.value;
    span.appendChild(tooltip);
    span.onmouseenter = function() {
      this.style.background = '#111111';
      this.style.borderColor = '#2a2a2a';
      tooltip.classList.add('active');
    };
    span.onmouseleave = function() {
      this.style.background = '#0a0a0a';
      this.style.borderColor = '#1a1a1a';
      tooltip.classList.remove('active');
    };
    span.addEventListener('click', function(e){
      e.stopPropagation();
      window.__closeWordTooltips();
      if (tooltip.classList.contains('active')) tooltip.classList.remove('active'); else tooltip.classList.add('active');
    }, { passive: true });
    el.appendChild(span);
  });
}

function buildTopAuthors(authors) {
  topAuthorsEl.innerHTML = '';
  if (!authors || !authors.length) {
    topAuthorsEl.textContent = 'No authors found';
    return;
  }
  authors.forEach(a => {
    const li = document.createElement('li');
    li.className = 'flex items-center justify-between p-3 rounded-lg border border-[#1a1a1a] bg-[#050505] hover:bg-[#0a0a0a] transition-colors cursor-pointer';
    li.innerHTML = `
      <div>
        <div class="font-semibold text-white">${escapeHtml(a.nickname)}</div>
        <div class="muted text-xs mt-0.5">@${escapeHtml(a.unique_id)}</div>
      </div>
      <div class="text-right">
        <div class="font-bold text-white text-lg">${a.count}</div>
        <div class="muted text-xs">reposts</div>
      </div>
    `;
    topAuthorsEl.appendChild(li);
  });
}

function buildRepostList(items) {
  repostList.innerHTML = '';
  if (!items || !items.length) {
    repostList.textContent = 'No reposts available';
    return;
  }

  items.forEach(item => {
    const card = document.createElement('article');
    card.className = 'p-4 rounded-xl border border-[#1a1a1a] bg-[#050505] flex gap-4 item-hover cursor-pointer';
    // Open modal with item details instead of navigating away
    card.addEventListener('click', (e) => {
      // allow click on links inside card to behave normally
      openPostModal(item);
    });

    // Get cover URL - API provides it directly in item.cover
    const coverUrl = item.cover || '';
    const isVideo = item.duration > 0;
    
    // Create wrapper for cover image with placeholder support
    const coverWrapper = document.createElement('div');
    coverWrapper.className = 'cover-img';
    coverWrapper.style.position = 'relative';
    coverWrapper.style.display = 'flex';
    coverWrapper.style.alignItems = 'center';
    coverWrapper.style.justifyContent = 'center';
    coverWrapper.style.backgroundColor = '#0a0a0a';
    coverWrapper.style.border = '1px solid #1a1a1a';
    
    if (coverUrl) {
      const cover = document.createElement('img');
      cover.style.width = '100%';
      cover.style.height = '100%';
      cover.style.objectFit = 'cover';
      cover.style.borderRadius = '8px';
      cover.alt = 'cover';
      cover.loading = 'lazy';
      cover.referrerPolicy = 'no-referrer';
      
      // Check if URL is .heic (video covers) - need conversion
      const needsConversion = coverUrl.includes('.heic') || 
                              coverUrl.includes('tiktokx-cropcenter-comet') ||
                              (isVideo && !coverUrl.includes('.webp') && !coverUrl.includes('.jpg') && !coverUrl.includes('.png'));
      
      // For photos (webp/jpg), use direct URL. For videos (.heic), use conversion proxy
      let imageUrl = coverUrl;
      if (needsConversion) {
        // Use weserv.nl image proxy to convert .heic to .jpg for browser compatibility
        imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(coverUrl)}&output=jpg&q=80`;
      }
      
      cover.src = imageUrl;
      
      // Track if placeholder was already added and retry attempts
      let placeholderAdded = false;
      let retryCount = 0;
      const maxRetries = 2;
      
      cover.onerror = function() {
        // If conversion proxy fails, try direct URL (might work for some browsers)
        if (retryCount === 0 && needsConversion) {
          retryCount++;
          this.src = coverUrl; // Try original URL
          return;
        }
        
        // If direct load fails, try with CORS proxy as fallback
        if (retryCount === 1 && proxy && coverUrl.startsWith('http')) {
          retryCount++;
          this.src = proxy + encodeURIComponent(coverUrl);
          return;
        }
        
        // Show placeholder if all attempts failed
        if (!placeholderAdded) {
          this.style.display = 'none';
          const placeholder = document.createElement('div');
          placeholder.textContent = 'üìπ';
          placeholder.style.fontSize = '2rem';
          placeholder.style.opacity = '0.2';
          placeholder.style.color = '#333333';
          coverWrapper.appendChild(placeholder);
          placeholderAdded = true;
        }
      };
      
      cover.onload = function() {
        // Image loaded successfully
        this.style.display = 'block';
      };
      
      coverWrapper.appendChild(cover);
    } else {
      // Show placeholder immediately if no cover URL
      const placeholder = document.createElement('div');
      placeholder.textContent = 'üìπ';
      placeholder.style.fontSize = '2rem';
      placeholder.style.opacity = '0.2';
      placeholder.style.color = '#333333';
      coverWrapper.appendChild(placeholder);
    }

    const meta = document.createElement('div');
    meta.className = 'flex-1';
    const desc = item.desc || '';
    const authorName = item.author && item.author.nickname ? item.author.nickname : (item.author && item.author.unique_id ? item.author.unique_id : 'unknown');
    const stats = item.stats || {};

    const formattedDate = formatDate(item.create_time);
    const duration = item.duration || 0;
    const formattedDuration = formatDuration(duration);
    
    meta.innerHTML = `
      <div class="flex items-start justify-between mb-3">
        <div class="flex-1 pr-4">
          <div class="font-semibold caption text-white mb-2">${escapeHtml(desc)}</div>
          <div class="muted text-xs mb-1">by <span class="text-white font-medium">${escapeHtml(authorName)}</span></div>
          ${duration > 0 ? `<div class="muted text-xs">‚è±Ô∏è ${formattedDuration}</div>` : '<div class="muted text-xs">üì∑ Photo</div>'}
        </div>
        <div class="text-right">
          <div class="grid grid-cols-2 gap-x-4 gap-y-1 muted text-xs">
            <div>
              <div class="text-white font-semibold">${numberWithCommas(stats.play_count || 0)}</div>
              <div>plays</div>
            </div>
            <div>
              <div class="text-white font-semibold">${numberWithCommas(stats.digg_count || 0)}</div>
              <div>likes</div>
            </div>
            <div>
              <div class="text-white font-semibold">${numberWithCommas(stats.comment_count || 0)}</div>
              <div>comments</div>
            </div>
            <div>
              <div class="text-white font-semibold">${numberWithCommas(stats.share_count || 0)}</div>
              <div>shares</div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-between pt-3 border-t border-[#1a1a1a] muted text-xs">
        <div class="flex items-center gap-1.5">
          <span>üìÖ</span>
          <span class="text-white">${formattedDate}</span>
        </div>
        <div class="font-mono text-[#666666]">${item.id || '-'}</div>
      </div>
    `;

    card.appendChild(coverWrapper);
    card.appendChild(meta);
    repostList.appendChild(card);
  });
}

/* Build charts */
function renderYearChart(yearly) {
  const ctx = document.getElementById('yearChart').getContext('2d');
  const labels = yearly.map(y => String(y.year));
  const data = yearly.map(y => y.count);

  if (yearChart) yearChart.destroy();
  yearChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Reposts per year',
        data,
        backgroundColor: '#2a2a2a',
        borderColor: '#3a3a3a',
        borderWidth: 1,
        borderRadius: 8,
        barThickness: 32
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { 
          grid: { display: false, color: '#1a1a1a' }, 
          ticks: { color: '#666666', font: { size: 11 } },
          border: { color: '#1a1a1a' }
        },
        y: { 
          beginAtZero: true, 
          ticks: { color: '#666666', font: { size: 11 } }, 
          grid: { color: '#1a1a1a' },
          border: { color: '#1a1a1a' }
        }
      }
    }
  });
}

function renderMonthChart(monthly) {
  // monthly is array of {year, month, count}
  // We'll convert to labels like YYYY-MM
  const sorted = (monthly || []).slice().sort((a,b) => {
    if (a.year === b.year) return a.month - b.month;
    return a.year - b.year;
  });
  const labels = sorted.map(m => `${m.year}-${String(m.month).padStart(2,'0')}`);
  const data = sorted.map(m => m.count);

  const ctx = document.getElementById('monthChart').getContext('2d');
  if (monthChart) monthChart.destroy();
  monthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Reposts per month',
        data,
        tension: 0.4,
        borderColor: '#3a3a3a',
        backgroundColor: 'rgba(58, 58, 58, 0.1)',
        pointRadius: 4,
        pointBackgroundColor: '#3a3a3a',
        pointBorderColor: '#2a2a2a',
        pointBorderWidth: 2,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { 
          grid: { display: false, color: '#1a1a1a' }, 
          ticks: { color: '#666666', font: { size: 11 } },
          border: { color: '#1a1a1a' }
        },
        y: { 
          beginAtZero: true, 
          ticks: { color: '#666666', font: { size: 11 } }, 
          grid: { color: '#1a1a1a' },
          border: { color: '#1a1a1a' }
        }
      }
    }
  });
}

function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

function numberWithCommas(x) {
  return x === undefined ? '0' : String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatDate(timestamp) {
  if (!timestamp) return '‚Äî';
  try {
    const date = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    // Format: "MMM DD, YYYY" or relative time for recent posts
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    const formatted = date.toLocaleDateString('en-US', options);
    
    // Add relative time for posts less than 30 days old
    if (diffDays === 0) {
      return 'Today';
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return `${diffDays} days ago`;
    } else if (diffDays < 30) {
      const weeks = Math.floor(diffDays / 7);
      return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
    } else {
      return formatted;
    }
  } catch (e) {
    return '‚Äî';
  }
}

function formatDuration(milliseconds) {
  if (!milliseconds || milliseconds === 0) return '‚Äî';
  const seconds = Math.floor(milliseconds / 1000);
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  
  if (minutes === 0) {
    return `${seconds}s`;
  } else if (remainingSeconds === 0) {
    return `${minutes}m`;
  } else {
    return `${minutes}m ${remainingSeconds}s`;
  }
}

function convertHeicToJpg(url) {
  if (!url) return url;
  
  // Check if URL contains .heic
  if (url.includes('.heic') || url.includes('tiktokx-cropcenter')) {
    // Try to convert .heic to .jpg by replacing the format
    // TikTok CDN URLs often have format parameters we can modify
    let converted = url
      .replace(/\.heic\?/i, '.jpg?')
      .replace(/\.heic&/i, '.jpg&')
      .replace(/\.heic$/i, '.jpg')
      .replace(/q72\.heic/i, 'q72.jpg')
      .replace(/tiktokx-cropcenter-comet/i, 'tiktokx-cropcenter');
    
    // If the URL has format parameters, try to force jpg format
    if (converted.includes('?')) {
      // Try adding format parameter or modifying existing ones
      if (!converted.includes('format=')) {
        converted += (converted.includes('?') ? '&' : '?') + 'format=jpg';
      }
    }
    
    return converted;
  }
  
  return url;
}

function getBrowserCompatibleCoverUrl(url, isVideo) {
  if (!url) return url;
  
  // If it's a video (has .heic or tiktokx-cropcenter), convert to jpg
  if (isVideo || url.includes('.heic') || url.includes('tiktokx-cropcenter-comet')) {
    return convertHeicToJpg(url);
  }
  
  // Photos are already in webp/jpg format, return as-is
  return url;
}

/* Main fetch flow */
async function fetchInsightsFor(username) {
  clearUI();
  showSkeleton(5);

  const api = `https://api.tiktokrepostremover.com/insights/reposts/count?username=${encodeURIComponent(username)}&all=1`;
  const url = proxy ? (proxy + encodeURIComponent(api)) : api;

  try {
    const res = await fetch(url, {
      headers: {
        // we can mimic a normal UA; not strictly necessary but harmless
        'User-Agent': 'Mozilla/5.0 (compatible; RepostInsights/1.0)'
      }
    });

    // Check network-level issues
    if (!res.ok) {
      throw new Error(`Network error: ${res.status} ${res.statusText}`);
    }

    const json = await res.json();

    // show quota info if present
    if (json.quota) {
      const quota = json.quota;
      const remaining = quota.remaining !== undefined ? quota.remaining : (quota.limit - quota.used);
      const premiumBadge = quota.isPremium ? ' ‚≠ê' : '';
      quotaEl.innerHTML = `
        <div class="flex items-center justify-between text-xs">
          <span>Quota: <span class="text-white">${quota.used}/${quota.limit}</span> used</span>
          <span class="text-white">${remaining} remaining${premiumBadge}</span>
        </div>
        ${quota.periodStart ? `<div class="text-xs mt-1 muted">Period: ${quota.periodStart}</div>` : ''}
        ${json.cached ? `<div class="text-xs mt-1 muted">üíæ Cached at ${json.cachedAt || 'recently'}</div>` : ''}
      `;
    } else {
      quotaEl.textContent = '';
    }

    // Populate summary
    sUsername.textContent = json.username || username;
    sCount.textContent = json.count ?? '0';
    sCapped.textContent = json.capped ? 'Yes' : 'No';
    sHardcap.textContent = json.hardCap ?? '‚Äî';
    sPages.textContent = json.pages ?? '‚Äî';
    sSampled.textContent = json.statsSampled ?? json.count ?? '‚Äî';
    summaryCard.classList.remove('hidden');

    // Word cloud
    if (json.wordCloud && json.wordCloud.length) {
      buildWordCloud(json.wordCloud);
      wordCloudCard.classList.remove('hidden');
    }

    // Top authors
    if (json.topAuthors && json.topAuthors.length) {
      buildTopAuthors(json.topAuthors);
      topAuthorsCard.classList.remove('hidden');
    }

    // Repost list
    if (json.items && json.items.length) {
      buildRepostList(json.items);
    } else {
      repostList.textContent = 'No repost items.';
    }

    // Charts
    const yearly = json.timeStats && json.timeStats.yearly ? json.timeStats.yearly : [];
    const monthly = json.timeStats && json.timeStats.monthly ? json.timeStats.monthly : [];
    renderYearChart(yearly);
    renderMonthChart(monthly);

    // raw JSON
    rawPre.textContent = JSON.stringify(json, null, 2);
    outputRawCard.classList.remove('hidden');

    hideSkeleton();
  }
  catch (err) {
    hideSkeleton();
    repostList.innerHTML = `<div class="p-4 rounded-lg border border-red-900/30 bg-red-950/20 text-red-400">Error: ${escapeHtml(err.message || String(err))}</div>`;
    rawPre.textContent = '';
    outputRawCard.classList.remove('hidden');
  }
}

async function fetchInsightsData(username) {
  const api = `https://api.tiktokrepostremover.com/insights/reposts/count?username=${encodeURIComponent(username)}&all=1`;
  const url = proxy ? (proxy + encodeURIComponent(api)) : api;
  const res = await fetch(url, { headers: { 'User-Agent': 'Mozilla/5.0 (compatible; RepostInsights/1.0)' } });
  if (!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
  return await res.json();
}

function computeWeightedJaccard(a, b) {
  const ma = new Map();
  const mb = new Map();
  (a || []).forEach(w => ma.set(String(w.text || '').toLowerCase(), Number(w.value || 0)));
  (b || []).forEach(w => mb.set(String(w.text || '').toLowerCase(), Number(w.value || 0)));
  const keys = new Set([...ma.keys(), ...mb.keys()]);
  let inter = 0;
  let uni = 0;
  keys.forEach(k => {
    const va = ma.get(k) || 0;
    const vb = mb.get(k) || 0;
    inter += Math.min(va, vb);
    uni += Math.max(va, vb);
  });
  if (uni === 0) return 0;
  return Math.round((inter / uni) * 100);
}

function computeOverlap(a, b) {
  const ma = new Map();
  const mb = new Map();
  (a || []).forEach(w => ma.set(String(w.text || '').toLowerCase(), Number(w.value || 0)));
  (b || []).forEach(w => mb.set(String(w.text || '').toLowerCase(), Number(w.value || 0)));
  const overlap = [];
  ma.forEach((va, k) => {
    const vb = mb.get(k);
    if (vb && (va > 0 || vb > 0)) overlap.push({ text: k, value: Math.min(va, vb) });
  });
  overlap.sort((x, y) => y.value - x.value);
  return overlap.slice(0, 10);
}

/* Theme initialization & toggle */
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  try{ localStorage.setItem('prefTheme', t); }catch(e){}
  if(themeIcon) themeIcon.textContent = (t === 'dark') ? 'üåô' : '‚òÄÔ∏è';
  if(themeToggle) themeToggle.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
}
function initTheme(){
  try{
    const stored = localStorage.getItem('prefTheme');
    if(stored) return applyTheme(stored);
  }catch(e){}
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(prefersDark ? 'dark' : 'light');
}
themeToggle && themeToggle.addEventListener('click', ()=>{
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(current === 'dark' ? 'light' : 'dark');
});
initTheme();

/* Disclaimer dismissal handling: persist user choice to hide */
(function(){
  const publicDisclaimer = document.getElementById('publicDisclaimer');
  const dismissBtn = document.getElementById('dismissDisclaimer');
  try{
    const hidden = localStorage.getItem('hidePublicDisclaimer') === '1';
    if(publicDisclaimer && hidden) publicDisclaimer.style.display = 'none';
  }catch(e){}
  if(dismissBtn){
    dismissBtn.addEventListener('click', ()=>{
      if(publicDisclaimer) publicDisclaimer.style.display = 'none';
      try{ localStorage.setItem('hidePublicDisclaimer','1'); }catch(e){}
    });
  }
})();

/* Attach events */
/* Post modal handlers */
const postModal = document.getElementById('postModal');
const postModalOverlay = document.getElementById('postModalOverlay');
const modalCover = document.getElementById('modalCover');
const modalAuthor = document.getElementById('modalAuthor');
const modalDesc = document.getElementById('modalDesc');
const modalPlays = document.getElementById('modalPlays');
const modalLikes = document.getElementById('modalLikes');
const modalComments = document.getElementById('modalComments');
const modalShares = document.getElementById('modalShares');
const modalId = document.getElementById('modalId');
const modalDate = document.getElementById('modalDate');
const openExternalBtn = document.getElementById('openExternalBtn');
const copyLinkBtn = document.getElementById('copyLinkBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
let __currentModalItem = null;

function showModal(){
  if(!postModal) return;
  postModal.classList.remove('hidden');
  postModal.setAttribute('aria-hidden','false');
}

function hideModal(){
  if(!postModal) return;
  postModal.classList.add('hidden');
  postModal.setAttribute('aria-hidden','true');
  __currentModalItem = null;
}

function openPostModal(item){
  __currentModalItem = item;
  // Cover ‚Äî use same conversion/fallback logic as the repost cards so HEIC covers work
  try{
    let imageUrl = item.cover || '';
    const isVideo = item.duration > 0;
    const needsConversion = imageUrl && (imageUrl.includes('.heic') || imageUrl.includes('tiktokx-cropcenter-comet') || (isVideo && !imageUrl.includes('.webp') && !imageUrl.includes('.jpg') && !imageUrl.includes('.png')));
    if (needsConversion) {
      imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl)}&output=jpg&q=80`;
    }
    if (modalCover) {
      modalCover.style.display = 'block';
      modalCover.src = imageUrl || '';
      modalCover.onerror = function(){
        // Hide broken image and show a lightweight placeholder instead
        this.style.display = 'none';
      };
    }
  }catch(e){ if(modalCover) modalCover.src = ''; }
  // Author & desc
  modalAuthor.textContent = item.author && (item.author.nickname || item.author.unique_id) ? `${item.author.nickname || item.author.unique_id}` : '';
  modalDesc.textContent = item.desc || '‚Äî';
  // stats
  const stats = item.stats || {};
  modalPlays.textContent = numberWithCommas(stats.play_count || 0);
  modalLikes.textContent = numberWithCommas(stats.digg_count || 0);
  modalComments.textContent = numberWithCommas(stats.comment_count || 0);
  modalShares.textContent = numberWithCommas(stats.share_count || 0);
  modalId.textContent = item.id || '-';
  if(modalDate) modalDate.textContent = formatDate(item.create_time);
  // wire buttons
  if(openExternalBtn){ openExternalBtn.onclick = ()=> { if(item.share_url) window.open(item.share_url, '_blank', 'noopener'); } }
  if(copyLinkBtn){ copyLinkBtn.onclick = async ()=> { try{ await navigator.clipboard.writeText(item.share_url || ''); alert('Link copied to clipboard'); } catch(e){ alert('Copy failed'); } } }
  showModal();
}

if(postModalOverlay) postModalOverlay.addEventListener('click', hideModal);
if(closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideModal(); });
fetchBtn.addEventListener('click', () => {
  const username = usernameInput.value.trim();
  if (!username) {
    alert('Please enter a TikTok username (e.g. meowtuah)');
    return;
  }
  if (duoMode) {
    return;
  }
  fetchInsightsFor(username);
});

usernameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') fetchBtn.click();
});

/* initialize skeleton */
showSkeleton(5);

if (singleModeBtn && duoModeBtn) {
  singleModeBtn.addEventListener('click', () => {
    duoMode = false;
    updateModeUI();
  });
  duoModeBtn.addEventListener('click', () => {
    duoMode = true;
    updateModeUI();
  });
}

compareBtn && compareBtn.addEventListener('click', async () => {
  const a = compareA.value.trim();
  const b = compareB.value.trim();
  if (!a || !b) {
    compareStatus.textContent = 'Enter both usernames';
    return;
  }
  compareStatus.textContent = 'Loading‚Ä¶';
  compareResult.classList.add('hidden');
  compareWordCloudA.innerHTML = '';
  compareWordCloudB.innerHTML = '';
  compareOverlap.innerHTML = '';
  try {
    const [ja, jb] = await Promise.all([fetchInsightsData(a), fetchInsightsData(b)]);
    const wa = ja.wordCloud || [];
    const wb = jb.wordCloud || [];
    buildWordCloudInto(compareWordCloudA, wa);
    buildWordCloudInto(compareWordCloudB, wb);
    compareLabelA.textContent = ja.username ? `@${ja.username}` : `@${a}`;
    compareLabelB.textContent = jb.username ? `@${jb.username}` : `@${b}`;
    const pct = computeWeightedJaccard(wa, wb);
    compareMatch.textContent = `${pct}%`;
    const ol = computeOverlap(wa, wb);
    if (ol.length) {
      ol.forEach(o => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-2 rounded-lg border border-[#1a1a1a] bg-[#050505]';
        li.innerHTML = `<span class="text-white">${o.text}</span><span class="muted text-xs">${o.value}</span>`;
        compareOverlap.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.className = 'muted text-xs';
      li.textContent = 'No overlapping tags';
      compareOverlap.appendChild(li);
    }
    compareStatus.textContent = '';
    compareResult.classList.remove('hidden');
  } catch (e) {
    compareStatus.textContent = String(e.message || e);
  }
});

</script>
</body>
</html>



